services:
  metabase:
    image: metabase/metabase:v0.58.6
    container_name: metabase
    depends_on:
      traefik:
        condition: service_healthy
    environment:
      - MB_DB_TYPE=h2
      - MB_DB_FILE=/var/lib/metabase/metabase.db
      - MB_SITE_URL=https://metabase.dev.localhost
    volumes:
      - metabase_data:/var/lib/metabase
    healthcheck:
      test: [CMD-SHELL, curl -f http://localhost:3000/api/health]
      interval: 1s
      timeout: 1s
      retries: 20
    labels:
      traefik.enable: 'true'
      traefik.http.routers.metabase.rule: Host(`metabase.dev.localhost`)
      traefik.http.routers.metabase.entrypoints: websecure
      traefik.http.routers.metabase.tls: 'true'
      traefik.http.services.metabase.loadbalancer.server.port: '3000'

volumes:
  metabase_data:
